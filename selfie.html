<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>かなたけちゃんと一緒に撮ろう（自撮り）</title>
  <meta name="description" content="カメラで撮影して、かなたけちゃんと一緒に1枚。位置とサイズも調整できます。" />
  <style>
    :root{
      --bg:#0b0b10;
      --panel: rgba(255,255,255,.08);
      --line: rgba(255,255,255,.16);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --accent:#ff5a73;
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow:hidden;
    }
    header{
      position:fixed;
      top:0; left:0; right:0;
      padding: 12px 12px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      z-index:10;
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,0));
    }
    .title{
      font-weight:900;
      font-size: 14px;
      letter-spacing:.02em;
    }
    .btn{
      border:1px solid var(--line);
      background: var(--panel);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight:800;
      text-decoration:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn.primary{
      border:none;
      background: linear-gradient(135deg, var(--accent), #ff7a8f);
      color:white;
    }

    .stage{
      position:fixed;
      inset:0;
      display:grid;
      place-items:center;
    }
    video, canvas{
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      background:#000;
    }
    #captureCanvas{ display:none; }

    .hint{
      position: fixed;
      left: 12px; right: 12px;
      bottom: 12px;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.14);
      border-radius: var(--radius);
      padding: 10px 12px;
      font-size: 12.5px;
      line-height: 1.6;
      color: var(--muted);
      z-index: 10;
      backdrop-filter: blur(8px);
    }
    .hint b{ color: var(--text); }

    .toast{
      position:fixed;
      left:50%;
      top:58px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.18);
      color: rgba(255,255,255,.92);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      display:none;
      z-index: 20;
    }
  </style>
</head>
<body>
  <header>
    <a class="btn" href="./index.html">← トップへ戻る</a>
    <div class="title">かなたけちゃんと一緒に撮ろう（自撮り）</div>
    <button class="btn primary" id="shotBtn">撮影して保存</button>
  </header>

  <div class="stage">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="overlay"></canvas>
    <canvas id="captureCanvas"></canvas>
  </div>

  <div class="toast" id="toast"></div>

  <div class="hint">
    <b>使い方：</b> かなたけちゃんは <b>ドラッグで移動</b>、<b>ピンチで拡大・縮小</b> できます。<br>
    <b>SNS投稿歓迎：</b> 顔出しNGの方は、あとからモザイク等で<b>編集してOK</b>です。周囲のお客様が写り込まないようご配慮ください。
  </div>

  <script>
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const ctx = overlay.getContext('2d');
    const captureCanvas = document.getElementById('captureCanvas');
    const cctx = captureCanvas.getContext('2d');
    const shotBtn = document.getElementById('shotBtn');
    const toast = document.getElementById('toast');

    const sticker = new Image();
    sticker.src = './kanatake.png';

    // ステッカー状態
    let st = {
      x: 0, y: 0,
      scale: 0.55,   // 初期サイズ
      w: 0, h: 0
    };

    // 2点タッチ用
    const pointers = new Map();
    let startDist = null;
    let startScale = null;
    let startCenter = null;
    let startPos = null;

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = 'block';
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.style.display='none', 1600);
    }

    async function startCamera(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user" },
          audio: false
        });
        video.srcObject = stream;
      }catch(e){
        showToast('カメラを起動できませんでした。権限をご確認ください。');
        console.error(e);
      }
    }

    function resize(){
      overlay.width = window.innerWidth * devicePixelRatio;
      overlay.height = window.innerHeight * devicePixelRatio;
      overlay.style.width = window.innerWidth + 'px';
      overlay.style.height = window.innerHeight + 'px';

      // ステッカーの実寸（画像サイズ基準）
      st.w = sticker.naturalWidth || 1024;
      st.h = sticker.naturalHeight || 1024;

      // 初期位置：中央やや下
      st.x = overlay.width * 0.5;
      st.y = overlay.height * 0.55;

      draw();
    }

    function draw(){
      ctx.clearRect(0,0,overlay.width, overlay.height);

      // ステッカー描画
      const drawW = st.w * st.scale * devicePixelRatio * 0.55;
      const drawH = st.h * st.scale * devicePixelRatio * 0.55;

      ctx.save();
      ctx.translate(st.x, st.y);
      ctx.drawImage(sticker, -drawW/2, -drawH/2, drawW, drawH);
      ctx.restore();
    }

    function dist(a,b){
      const dx = a.x - b.x;
      const dy = a.y - b.y;
      return Math.hypot(dx,dy);
    }

    function center(a,b){
      return { x: (a.x+b.x)/2, y:(a.y+b.y)/2 };
    }

    function canvasPoint(e){
      const rect = overlay.getBoundingClientRect();
      const x = (e.clientX - rect.left) * devicePixelRatio;
      const y = (e.clientY - rect.top) * devicePixelRatio;
      return { x, y };
    }

    overlay.addEventListener('pointerdown', (e)=>{
      overlay.setPointerCapture(e.pointerId);
      pointers.set(e.pointerId, canvasPoint(e));

      if(pointers.size === 1){
        startPos = { x: st.x, y: st.y };
      }
      if(pointers.size === 2){
        const [p1,p2] = [...pointers.values()];
        startDist = dist(p1,p2);
        startScale = st.scale;
        startCenter = center(p1,p2);
        startPos = { x: st.x, y: st.y };
      }
    });

    overlay.addEventListener('pointermove', (e)=>{
      if(!pointers.has(e.pointerId)) return;
      pointers.set(e.pointerId, canvasPoint(e));

      if(pointers.size === 1){
        const p = [...pointers.values()][0];
        // 移動：ポインタへ追従（自然に）
        st.x = p.x;
        st.y = p.y;
        draw();
      }
      if(pointers.size === 2){
        const [p1,p2] = [...pointers.values()];
        const d = dist(p1,p2);
        const c = center(p1,p2);

        const ratio = d / (startDist || d);
        st.scale = Math.max(0.15, Math.min(1.6, (startScale || st.scale) * ratio));

        // 中心に合わせて移動
        st.x = (startPos?.x ?? st.x) + (c.x - (startCenter?.x ?? c.x));
        st.y = (startPos?.y ?? st.y) + (c.y - (startCenter?.y ?? c.y));
        draw();
      }
    });

    function endPointer(e){
      pointers.delete(e.pointerId);
      if(pointers.size < 2){
        startDist = null; startScale = null; startCenter = null;
      }
    }
    overlay.addEventListener('pointerup', endPointer);
    overlay.addEventListener('pointercancel', endPointer);

    // 撮影：videoフレーム + ステッカー合成 → 画像保存/共有
    shotBtn.addEventListener('click', async ()=>{
      if(!video.videoWidth){
        showToast('カメラ準備中です。少し待ってからお試しください。');
        return;
      }
      const w = video.videoWidth;
      const h = video.videoHeight;

      captureCanvas.width = w;
      captureCanvas.height = h;

      // videoをそのまま描画
      cctx.drawImage(video, 0, 0, w, h);

      // ステッカー座標を video サイズへ変換
      const sx = st.x / overlay.width * w;
      const sy = st.y / overlay.height * h;

      const baseW = (st.w || 1024) * st.scale * 0.55;
      const baseH = (st.h || 1024) * st.scale * 0.55;

      // overlay基準のサイズ → video基準へ
      const drawW = baseW / overlay.width * w * devicePixelRatio;
      const drawH = baseH / overlay.height * h * devicePixelRatio;

      cctx.drawImage(sticker, sx - drawW/2, sy - drawH/2, drawW, drawH);

      captureCanvas.toBlob(async (blob)=>{
        if(!blob){ showToast('保存に失敗しました。'); return; }

        const file = new File([blob], 'kanatake_selfie.png', { type: 'image/png' });

        // Web Share（対応端末）
        if(navigator.canShare && navigator.canShare({ files: [file] })){
          try{
            await navigator.share({
              title: 'かなたけちゃんAR',
              text: 'かなたけちゃんと一緒に撮りました。',
              files: [file]
            });
            showToast('共有しました。');
            return;
          }catch(e){
            // キャンセル等
          }
        }

        // 非対応ならダウンロード
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'kanatake_selfie.png';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showToast('画像を保存しました。');
      }, 'image/png', 1.0);
    });

    sticker.onload = ()=>{
      resize();
      startCamera();
      showToast('ドラッグで移動、ピンチでサイズ調整できます。');
    };

    window.addEventListener('resize', resize, { passive:true });
  </script>
</body>
</html>
