<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#F7F4F2" />
  <title>かなたけちゃんと一緒に撮ろう（自撮り）｜かなたけちゃんAR</title>

  <style>
    :root{
      --ink:#1B1B1F; --sub:#5B5B67;
      --brand:#E94B5A; --brand2:#FF7A7A;
      --stroke:#00000010; --shadow:0 18px 50px rgba(16,24,40,.12);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", "Segoe UI", sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 20% 0%, #FFE7EA 0%, transparent 60%),
        radial-gradient(900px 500px at 90% 10%, #E8F5FF 0%, transparent 55%),
        linear-gradient(180deg, #F7F4F2, #FFFFFF);
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:22px 16px 34px;}
    h1{margin:0 0 6px;font-size:24px;}
    p{margin:8px 0 0;color:var(--sub);line-height:1.7;font-size:13px;}

    .panel{
      margin-top:14px;
      background:#FFFFFFCC;
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(8px);
    }

    .stage{
      position:relative;
      width:100%;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background: linear-gradient(180deg,#111,#333);
      box-shadow: 0 16px 30px rgba(16,24,40,.10);
      touch-action:none;
    }
    video{
      width:100%;
      height:auto;
      display:block;
      background:#000;
    }
    .overlay{
      position:absolute;
      left:0; top:0;
      width: 220px;
      height:auto;
      transform-origin: 0 0;
      user-select:none;
      -webkit-user-drag:none;
      touch-action:none;
      filter: drop-shadow(0 16px 20px rgba(0,0,0,.25));
    }
    .overlayHint{
      position:absolute;
      left:12px; top:12px;
      padding:8px 10px;
      border-radius:12px;
      background: rgba(255,255,255,.85);
      border:1px solid var(--stroke);
      font-size:12px;
      color:var(--sub);
      backdrop-filter: blur(8px);
    }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:12px;
    }
    button, a.btn{
      appearance:none;
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:800;
      letter-spacing:.02em;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    button.primary{
      color:#fff;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 16px 30px rgba(233,75,90,.28);
      border:1px solid rgba(255,255,255,.25);
    }
    button.ghost, a.btn.ghost{
      color:var(--ink);
      background:#FFFFFFAA;
      border:1px solid var(--stroke);
    }
    button.small{
      padding:10px 12px;
      font-weight:800;
    }
    .note{
      margin-top:12px;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--stroke);
      background:#FFFFFFAA;
      color:var(--sub);
      font-size:12px;
      line-height:1.75;
    }

    .result{
      display:none;
      margin-top:12px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid var(--stroke);
      background:#fff;
    }
    .result img{width:100%;height:auto;display:block}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>かなたけちゃんと一緒に撮ろう（自撮り）</h1>
    <p>かなたけちゃんは、指で移動／「サイズ＋−」で拡大縮小できます。</p>

    <div class="panel">
      <div class="stage" id="stage">
        <div class="overlayHint">かなたけちゃんを動かして、撮影してください</div>
        <video id="video" playsinline autoplay muted></video>
        <img id="sticker" class="overlay" src="./kanatake.png" alt="かなたけちゃん">
      </div>

      <div class="controls">
        <button class="ghost small" id="flip">カメラ切替</button>
        <button class="ghost small" id="bigger">サイズ＋</button>
        <button class="ghost small" id="smaller">サイズ−</button>
        <button class="primary" id="shot">撮影する</button>
        <button class="ghost" id="reset">リセット</button>
        <a class="btn ghost" href="./index.html">トップへ戻る</a>
      </div>

      <div class="note">
        撮影したら、よろしければSNSで共有してください。<br>
        ※顔出しが難しい場合は、ぼかし・スタンプ等で編集してから投稿いただいて構いません。<br>
        ※周囲のお客様が写り込まないようご配慮ください。
      </div>

      <div class="result" id="result">
        <img id="resultImg" alt="撮影結果">
        <div class="controls" style="padding:12px;">
          <a class="btn primary" id="download" href="#" download="kanatake_selfie.png">画像を保存</a>
          <button class="ghost" id="closeResult">戻る</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const stage = document.getElementById('stage');
    const sticker = document.getElementById('sticker');

    const btnFlip = document.getElementById('flip');
    const btnBigger = document.getElementById('bigger');
    const btnSmaller = document.getElementById('smaller');
    const btnShot = document.getElementById('shot');
    const btnReset = document.getElementById('reset');

    const result = document.getElementById('result');
    const resultImg = document.getElementById('resultImg');
    const download = document.getElementById('download');
    const closeResult = document.getElementById('closeResult');

    let stream = null;
    let facingMode = 'user';

    // ステッカー状態（stage内のCSSピクセル基準）
    let state = { x: 20, y: 80, scale: 1.0 };

    function applySticker(){
      sticker.style.transform = `translate(${state.x}px, ${state.y}px) scale(${state.scale})`;
    }

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    async function startCamera(){
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
      }catch(e){
        alert('カメラを起動できませんでした。ブラウザの権限設定をご確認ください。');
      }
    }

    // ドラッグ（1本指）
    let dragging = false;
    let start = { px:0, py:0, x:0, y:0 };

    function pointFromEvent(ev){
      const p = ev.touches ? ev.touches[0] : ev;
      return { x: p.clientX, y: p.clientY };
    }

    function withinSticker(target){
      return target === sticker;
    }

    stage.addEventListener('pointerdown', (ev) => {
      if(!withinSticker(ev.target)) return;
      dragging = true;
      sticker.setPointerCapture(ev.pointerId);
      const p = pointFromEvent(ev);
      start = { px: p.x, py: p.y, x: state.x, y: state.y };
    });

    stage.addEventListener('pointermove', (ev) => {
      if(!dragging) return;
      const p = pointFromEvent(ev);
      const dx = p.x - start.px;
      const dy = p.y - start.py;
      state.x = start.x + dx;
      state.y = start.y + dy;
      applySticker();
    });

    stage.addEventListener('pointerup', () => { dragging = false; });
    stage.addEventListener('pointercancel', () => { dragging = false; });

    btnBigger.addEventListener('click', () => {
      state.scale = clamp(state.scale + 0.12, 0.35, 3.0);
      applySticker();
    });
    btnSmaller.addEventListener('click', () => {
      state.scale = clamp(state.scale - 0.12, 0.35, 3.0);
      applySticker();
    });

    btnFlip.addEventListener('click', async () => {
      facingMode = (facingMode === 'user') ? 'environment' : 'user';
      await startCamera();
    });

    btnReset.addEventListener('click', () => {
      state = { x: 20, y: 80, scale: 1.0 };
      applySticker();
    });

    closeResult.addEventListener('click', () => {
      result.style.display = 'none';
    });

    // 撮影（videoとstickerを合成）
    btnShot.addEventListener('click', () => {
      if(!video.videoWidth || !video.videoHeight){
        alert('カメラ映像の準備中です。少し待ってからお試しください。');
        return;
      }

      // 表示サイズ
      const rectVideo = video.getBoundingClientRect();
      const rectStage = stage.getBoundingClientRect();

      // stage内でのvideo左上（ここではvideoがstage幅100%なので、ほぼ一致）
      const displayW = rectVideo.width;
      const displayH = rectVideo.height;

      // 実ピクセルへ変換
      const sx = video.videoWidth / displayW;
      const sy = video.videoHeight / displayH;

      // キャンバス（動画解像度で出力）
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');

      // video描画（object-fit: デフォルトでそのまま）
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // sticker描画位置（stage基準 → video表示基準へ）
      // stageとvideoは同じレイアウト前提（videoがstage内で100%）
      const px = (state.x) * sx;
      const py = (state.y) * sy;

      // sticker実表示幅（CSS上の元画像幅 * scale）
      const stickerW = sticker.naturalWidth * state.scale;
      const stickerH = sticker.naturalHeight * state.scale;

      // CSS表示の sticker 幅は固定220pxから始まるが、naturalWidthとズレる可能性があるため補正
      // 現在の表示幅を取得して、自然サイズ比を使う
      const rectSticker = sticker.getBoundingClientRect();
      const dispStickerW = rectSticker.width;
      const dispStickerH = rectSticker.height;

      const pw = dispStickerW * sx;
      const ph = dispStickerH * sy;

      // 透過PNGとして描画
      ctx.drawImage(sticker, px, py, pw, ph);

      const url = canvas.toDataURL('image/png');
      resultImg.src = url;
      download.href = url;
      result.style.display = 'block';
    });

    // 初期化
    (async function(){
      applySticker();
      await startCamera();
    })();
  </script>
</body>
</html>
