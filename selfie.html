<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>かなたけちゃんと一緒に撮ろう（自撮り）</title>
  <meta name="robots" content="noindex" />
  <style>
    :root{ --ink:#2b2b2b; --muted:#6a6a6a; --accent:#ef5a67; --accent2:#ff7b86; }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
      color:var(--ink);
      background:#0b0b0c;
    }
    .topbar{
      position:fixed; left:0; right:0; top:0;
      padding:12px 12px calc(12px + env(safe-area-inset-top));
      background:linear-gradient(180deg, rgba(0,0,0,.70), rgba(0,0,0,0));
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      z-index:10;
    }
    .title{color:#fff; font-weight:900; font-size:14px}
    .btn{
      appearance:none; border:none;
      padding:10px 12px; border-radius:12px;
      background:linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff; font-weight:900;
    }
    .btn2{
      appearance:none; border:1px solid rgba(255,255,255,.25);
      padding:10px 12px; border-radius:12px;
      background:rgba(255,255,255,.06);
      color:#fff; font-weight:800;
    }
    .stage{
      position:fixed; inset:0;
      overflow:hidden;
    }
    video{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit:cover;
      transform: scaleX(-1); /* 自撮りミラー */
    }
    canvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      touch-action:none;
    }
    .hint{
      position:fixed; left:12px; right:12px; bottom:12px;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      border-radius:16px;
      background:rgba(255,255,255,.92);
      color:var(--ink);
      font-size:13px;
      line-height:1.7;
      z-index:10;
    }
    .hint b{display:block; margin-bottom:4px}
    .hint small{color:var(--muted)}
    .link{
      color:#2b2b2b;
      text-decoration:underline;
      font-weight:800;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">かなたけちゃんと一緒に撮ろう（自撮り）</div>
    <div style="display:flex; gap:10px;">
      <button class="btn2" id="switchBtn" type="button">カメラ切替</button>
      <button class="btn" id="shotBtn" type="button">撮影</button>
    </div>
  </div>

  <div class="stage">
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="hint">
    <b>操作</b>
    指でドラッグして移動／2本指で拡大・縮小できます。<br>
    写真を撮ったら、よろしければSNSで共有してください。<br>
    <small>
      ※周囲のお客様が写り込まないようご配慮ください。<br>
      ※顔出しNGの方は、スタンプ・ぼかし等で<b>編集していただいて大丈夫</b>です。
    </small><br>
    <a class="link" href="index.html">トップへ戻る</a>
  </div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const shotBtn = document.getElementById("shotBtn");
    const switchBtn = document.getElementById("switchBtn");

    let stream = null;
    let facingMode = "user"; // self camera

    // overlay image
    const overlay = new Image();
    overlay.src = "kanatake.png";

    // overlay transform
    let ox = 0, oy = 0, scale = 0.45;
    let dragging = false;
    let lastX = 0, lastY = 0;

    // pinch
    let pinch = false;
    let startDist = 0;
    let startScale = 1;

    function resize(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    async function startCamera(){
      if(stream){
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode },
          audio: false
        });
        video.srcObject = stream;
      }catch(e){
        alert("カメラが起動できませんでした。Safari / Chromeで開き直してお試しください。");
      }
    }

    function draw(){
      requestAnimationFrame(draw);

      // canvas上に “見えている状態” を描画（撮影用に使う）
      ctx.clearRect(0,0,window.innerWidth,window.innerHeight);

      // overlay
      const ow = overlay.naturalWidth || 1024;
      const oh = overlay.naturalHeight || 1024;
      const w = ow * scale;
      const h = oh * scale;

      // 初期位置（ロード直後だけ中央寄せ）
      if(ox === 0 && oy === 0 && overlay.complete){
        ox = (window.innerWidth - w) * 0.5;
        oy = (window.innerHeight - h) * 0.55;
      }

      // 影を薄く（合成の視認性だけ上げる）
      ctx.save();
      ctx.globalAlpha = 0.98;
      ctx.drawImage(overlay, ox, oy, w, h);
      ctx.restore();
    }

    function getTouchDist(t1, t2){
      const dx = t2.clientX - t1.clientX;
      const dy = t2.clientY - t1.clientY;
      return Math.hypot(dx, dy);
    }

    canvas.addEventListener("touchstart", (e) => {
      if(e.touches.length === 1){
        dragging = true;
        lastX = e.touches[0].clientX;
        lastY = e.touches[0].clientY;
      }else if(e.touches.length === 2){
        pinch = true;
        startDist = getTouchDist(e.touches[0], e.touches[1]);
        startScale = scale;
      }
    }, {passive:false});

    canvas.addEventListener("touchmove", (e) => {
      e.preventDefault();
      if(pinch && e.touches.length === 2){
        const dist = getTouchDist(e.touches[0], e.touches[1]);
        const ratio = dist / Math.max(1, startDist);
        scale = Math.min(1.4, Math.max(0.12, startScale * ratio));
      }else if(dragging && e.touches.length === 1){
        const x = e.touches[0].clientX;
        const y = e.touches[0].clientY;
        ox += (x - lastX);
        oy += (y - lastY);
        lastX = x; lastY = y;
      }
    }, {passive:false});

    canvas.addEventListener("touchend", (e) => {
      dragging = false;
      if(e.touches.length < 2) pinch = false;
    });

    switchBtn.addEventListener("click", async () => {
      facingMode = (facingMode === "user") ? "environment" : "user";
      // ミラーは自撮りだけ
      video.style.transform = (facingMode === "user") ? "scaleX(-1)" : "none";
      await startCamera();
    });

    shotBtn.addEventListener("click", () => {
      // 撮影：video + overlay を合成してダウンロード
      const w = video.videoWidth;
      const h = video.videoHeight;
      if(!w || !h){
        alert("カメラの準備中です。少し待ってからお試しください。");
        return;
      }

      const out = document.createElement("canvas");
      out.width = w; out.height = h;
      const octx = out.getContext("2d");

      // video描画（自撮り時は左右反転を反映）
      if(facingMode === "user"){
        octx.save();
        octx.translate(w, 0);
        octx.scale(-1, 1);
        octx.drawImage(video, 0, 0, w, h);
        octx.restore();
      }else{
        octx.drawImage(video, 0, 0, w, h);
      }

      // overlay位置を video座標へ変換（画面比率差を考慮）
      // 表示は object-fit: cover なので、その分を計算
      const vw = window.innerWidth, vh = window.innerHeight;
      const videoAR = w / h;
      const viewAR = vw / vh;

      let drawW, drawH, offX, offY;
      if(videoAR > viewAR){
        // 横が余る（左右がはみ出す）
        drawH = vh;
        drawW = vh * videoAR;
        offX = (vw - drawW) / 2;
        offY = 0;
      }else{
        // 縦が余る（上下がはみ出す）
        drawW = vw;
        drawH = vw / videoAR;
        offX = 0;
        offY = (vh - drawH) / 2;
      }

      const sx = (ox - offX) / drawW * w;
      const sy = (oy - offY) / drawH * h;

      const ow = (overlay.naturalWidth || 1024) * scale / drawW * w;
      const oh = (overlay.naturalHeight || 1024) * scale / drawH * h;

      octx.drawImage(overlay, sx, sy, ow, oh);

      const url = out.toDataURL("image/png");
      const a = document.createElement("a");
      a.href = url;
      a.download = "kanatake_cam.png";
      a.click();
    });

    window.addEventListener("resize", resize);

    resize();
    startCamera();
    draw();
  </script>
</body>
</html>
